name: Build (Windows)

on:
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "main" ]
    workflow_call:
        inputs:
            release:
                description: "Build in Release mode and produce release artifacts"
                required: false
                type: boolean
                default: false

jobs:
    build:
        runs-on: windows-latest

        defaults:
            run:
                shell: msys2 {0}

        steps:
          - name: Setup MSYS2
            id: msys2
            uses: msys2/setup-msys2@v2
            with:
                update: true
                msystem: MINGW64
                install: >-
                    git
                    zip
                    make
                    mingw-w64-x86_64-cmake
                    mingw-w64-x86_64-ninja
                    mingw-w64-x86_64-clang
                    mingw-w64-x86_64-headers-git
                    mingw-w64-x86_64-rust
                    mingw-w64-x86_64-python-jinja
                    mingw-w64-x86_64-miniupnpc

          - name: Checkout repository
            uses: actions/checkout@v4
            with:
                submodules: recursive

          - name: Cache dependencies
            uses: actions/cache@v4
            with:
                path: third_party
                key: windows-x64-deps-${{ hashFiles('build-deps.sh') }}
                restore-keys: windows-x64-deps-

          - name: Cache Rust/Cargo
            uses: actions/cache@v4
            with:
                path: |
                    ~/.cargo/registry
                    ~/.cargo/git
                key: windows-cargo-${{ hashFiles('build-deps.sh') }}
                restore-keys: windows-cargo-

          - name: Build dependencies
            run: sh build-deps.sh

          - name: Build for Windows
            run: |
                set -o pipefail

                BUILD_TYPE=${{ inputs.release && 'Release' || 'Debug' }}
                MSYS2_PYTHON=$(which python3)

                CC=clang CXX=clang++ cmake -B build \
                    -G Ninja \
                    -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
                    -DENABLE_TESTS=OFF \
                    -DMSYS2_LOCATION=${{ steps.msys2.outputs.msys2-location }} \
                    -DPython3_EXECUTABLE=$MSYS2_PYTHON \
                    -DPython_EXECUTABLE=$MSYS2_PYTHON

                cmake --build build --parallel 2>&1 | tee build.log

          - name: Install and package
            if: ${{ inputs.release }}
            run: |
                cmake --install build --prefix dist
                SHORT_SHA="${GITHUB_SHA::7}"
                cd dist && zip -r "../3SX-${SHORT_SHA}-windows.zip" . && cd ..

          - name: Upload release artifact
            if: ${{ inputs.release }}
            uses: actions/upload-artifact@v4
            with:
                name: release-assets-windows
                path: 3SX-*-windows.zip

          - name: Save build log (local act)
            if: ${{ always() && env.ACT }}
            run: |
                mkdir -p $GITHUB_WORKSPACE/build_output
                cp build.log $GITHUB_WORKSPACE/build_output/build-log-windows.log
                echo "âœ… Build log saved to build_output/build-log-windows.log"

          - name: Upload build log (GitHub)
            if: ${{ always() && !env.ACT && !inputs.release }}
            uses: actions/upload-artifact@v4
            with:
                name: build-log
                path: build.log
