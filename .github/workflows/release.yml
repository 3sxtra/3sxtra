name: Create Release

on:
  push:
    branches:
      - "main"

permissions:
  contents: write

jobs:
  build-linux:
    name: Build (Linux x86_64)
    runs-on: ubuntu-latest
    container:
      image: ubuntu:25.04
    steps:
      - name: Install Git and tools
        run: |
          apt-get update
          apt-get install -y git curl nasm
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: third_party_linux
          key: linux-x64-deps-${{ hashFiles('build-deps.sh') }}

      - name: Cache Rust/Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: linux-x64-cargo-${{ hashFiles('build-deps.sh') }}
          restore-keys: linux-x64-cargo-

      - name: Install build dependencies
        run: |
          apt-get install -y $(cat tools/requirements-ubuntu-sdl3.txt)
          apt-get install -y clang zip python3-jinja2

      - name: Build dependencies from source
        env:
          THIRD_PARTY: ${{ github.workspace }}/third_party_linux
        run: |
          chmod +x build-deps.sh
          ./build-deps.sh

      - name: Configure and build
        run: |
          set -o pipefail
          CC=clang CXX=clang++ cmake -B build-linux \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_TESTS=OFF \
            -DTHIRD_PARTY_DIR=${{ github.workspace }}/third_party_linux
          cmake --build build-linux --parallel

      - name: Package with CPack
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          cd build-linux
          cpack -G TGZ --config CPackConfig.cmake
          cd ..
          ARCHIVE="$(find build-linux -maxdepth 1 -name '*.tar.gz' | head -1)"
          mv "$ARCHIVE" "3SX-${SHORT_SHA}-linux-x86_64.tar.gz"

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-linux-x86_64
          path: 3SX-*-linux-x86_64.tar.gz

  build-linux-arm64:
    name: Build (Linux ARM64 Cross-Compile)
    runs-on: ubuntu-latest
    container:
      image: ubuntu:25.04
    steps:
      - name: Install Git and cross-compile toolchain
        env:
          DEBIAN_FRONTEND: noninteractive
          TZ: UTC
        run: |
          apt-get update
          apt-get install -y git curl xz-utils nodejs

          dpkg --add-architecture arm64

          for f in /etc/apt/sources.list.d/*.sources; do
              if [ -f "$f" ] && ! grep -q 'Architectures:' "$f"; then
                  sed -i '/^Types:/a Architectures: amd64' "$f"
              fi
          done

          printf '%s\n' \
              'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports plucky main restricted universe multiverse' \
              'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports plucky-updates main restricted universe multiverse' \
              'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports plucky-security main restricted universe multiverse' \
              > /etc/apt/sources.list.d/arm64-ports.list

          apt-get update
          apt-get install -y crossbuild-essential-arm64 cmake ninja-build make pkg-config clang zip file qemu-user-static python3-jinja2

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache ARM64 dependencies
        uses: actions/cache@v4
        with:
          path: third_party_arm64
          key: linux-arm64-cross-deps-${{ hashFiles('build-deps.sh') }}

      - name: Cache Rust/Cargo
        uses: actions/cache@v4
        with:
          path: |
            /opt/cargo/registry
            /opt/cargo/git
          key: linux-arm64-cargo-${{ hashFiles('build-deps.sh') }}
          restore-keys: linux-arm64-cargo-

      - name: Install ARM64 build dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get install -y \
            libasound2-dev:arm64 libpulse-dev:arm64 \
            libx11-dev:arm64 libxext-dev:arm64 libxrandr-dev:arm64 \
            libxcursor-dev:arm64 libxfixes-dev:arm64 libxi-dev:arm64 \
            libxrender-dev:arm64 libxinerama-dev:arm64 libxtst-dev:arm64 \
            libxss-dev:arm64 libxkbcommon-dev:arm64 libxkbcommon-x11-dev:arm64 \
            libdrm-dev:arm64 libgbm-dev:arm64 \
            libgl1-mesa-dev:arm64 libgles2-mesa-dev:arm64 \
            libegl1-mesa-dev:arm64 libdbus-1-dev:arm64 libudev-dev:arm64 \
            libpipewire-0.3-dev:arm64 \
            libwayland-dev:arm64 libwayland-egl1:arm64 libdecor-0-dev:arm64 \
            libminiupnpc-dev:arm64 \
            wayland-protocols

      - name: Install Rust toolchain (cross-compile)
        run: |
          export RUSTUP_HOME=/opt/rustup
          export CARGO_HOME=/opt/cargo
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          echo "RUSTUP_HOME=/opt/rustup" >> $GITHUB_ENV
          echo "CARGO_HOME=/opt/cargo" >> $GITHUB_ENV
          echo "/opt/cargo/bin" >> $GITHUB_PATH
          . /opt/cargo/env
          rustup target add aarch64-unknown-linux-gnu

      - name: Pre-build dependencies
        env:
            CARGO_BUILD_TARGET: aarch64-unknown-linux-gnu
            CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
            CC: aarch64-linux-gnu-gcc
            CXX: aarch64-linux-gnu-g++
            PKG_CONFIG_PATH: /usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
            PKG_CONFIG_LIBDIR: /usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
        run: |
            export THIRD_PARTY="$GITHUB_WORKSPACE/third_party_arm64"
            export THIRD_PARTY_DIR="$THIRD_PARTY"
            cd $GITHUB_WORKSPACE
            chmod +x ./build-deps.sh
            ./build-deps.sh

            mkdir -p $THIRD_PARTY/librashader/target/release
            cp $THIRD_PARTY/librashader/target/aarch64-unknown-linux-gnu/release/liblibrashader_capi.a $THIRD_PARTY/librashader/target/release/
        shell: bash

      - name: Build
        env:
            PKG_CONFIG_PATH: /usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
            PKG_CONFIG_LIBDIR: /usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
        run: |
            set -o pipefail
            cmake -B build-linux-arm64 \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_TOOLCHAIN_FILE=cmake/aarch64-linux-gnu.cmake \
                -DENABLE_TESTS=OFF \
                -DTHIRD_PARTY_DIR=$GITHUB_WORKSPACE/third_party_arm64 \
                -G Ninja
            cmake --build build-linux-arm64 --parallel
        shell: bash

      - name: Package with CPack
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          cd build-linux-arm64
          cpack -G TGZ --config CPackConfig.cmake
          cd ..
          ARCHIVE="$(find build-linux-arm64 -maxdepth 1 -name '*.tar.gz' | head -1)"
          mv "$ARCHIVE" "3SX-${SHORT_SHA}-linux-arm64.tar.gz"

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-linux-arm64
          path: 3SX-*-linux-arm64.tar.gz

  build-windows:
    name: Build (Windows x86_64)
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Setup MSYS2
        id: msys2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: MINGW64
          install: >-
            git
            zip
            make
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-clang
            mingw-w64-x86_64-headers-git
            mingw-w64-x86_64-rust
            mingw-w64-x86_64-python-jinja
            mingw-w64-x86_64-miniupnpc

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: third_party
          key: Windows-deps-${{ hashFiles('build-deps.sh') }}

      - name: Cache Rust/Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: windows-cargo-${{ hashFiles('build-deps.sh') }}
          restore-keys: windows-cargo-

      - name: Build dependencies from source
        run: |
          chmod +x build-deps.sh
          ./build-deps.sh

      - name: Configure and build
        run: |
          set -o pipefail

          MSYS2_PYTHON=$(which python3)

          CC=clang CXX=clang++ cmake -S . -B build \
            -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_TESTS=OFF \
            -DMSYS2_LOCATION=${{ steps.msys2.outputs.msys2-location }} \
            -DPython3_EXECUTABLE=$MSYS2_PYTHON \
            -DPython_EXECUTABLE=$MSYS2_PYTHON
          cmake --build build --parallel

      - name: Install and package
        run: |
          cmake --install build --prefix dist
          SHORT_SHA="${GITHUB_SHA::7}"
          cd dist && zip -r "../3SX-${SHORT_SHA}-windows.zip" . && cd ..

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-windows
          path: 3SX-*-windows.zip

  build-macos:
    name: Build (macOS arm64)
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: third_party
          key: macos-deps-${{ hashFiles('build-deps.sh') }}
          restore-keys: macos-deps-

      - name: Cache Rust/Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: macos-cargo-${{ hashFiles('build-deps.sh') }}
          restore-keys: macos-cargo-

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          brew install miniupnpc
          python3 -m pip install --break-system-packages jinja2
          sh build-deps.sh

      - name: Configure and build
        run: |
          set -o pipefail
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_TESTS=OFF
          cmake --build build --parallel
        shell: bash

      - name: Package DMG with CPack
        run: |
          set -euo pipefail
          cpack -G DragNDrop --config build/CPackConfig.cmake

          DMG_PATH="$(find . -maxdepth 1 -type f -name '*.dmg' | head -n 1)"
          if [ -z "${DMG_PATH}" ]; then
            echo "No .dmg package found"
            exit 1
          fi

          SHORT_SHA="${GITHUB_SHA::7}"
          mv "${DMG_PATH}" "3SX-${SHORT_SHA}-macos.dmg"
        shell: bash

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-macos
          path: 3SX-*-macos.dmg

  build-flatpak:
    name: Build Flatpak
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:freedesktop-24.08
      options: --privileged
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build Flatpak bundle
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          manifest-path: flatpak/io.github.threestylextra.app.yml
          bundle: 3sx.flatpak
          arch: x86_64
          cache-key: flatpak-builder-${{ hashFiles('flatpak/io.github.threestylextra.app.yml') }}

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-flatpak
          path: 3sx.flatpak

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-linux-arm64, build-windows, build-macos, build-flatpak]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all release assets
        uses: actions/download-artifact@v4
        with:
          pattern: release-assets-*
          merge-multiple: true
          path: release-assets

      - name: Move rolling release tag
        env:
          TAG_NAME: rolling-pre-release
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -f "${TAG_NAME}" "${GITHUB_SHA}"
          git push origin "refs/tags/${TAG_NAME}" --force

      - name: Create or update GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG_NAME: rolling-pre-release
          FULL_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          SHORT_SHA="${FULL_SHA:0:7}"

          cat > notes.md <<EOF
          Automatic release for commit ${FULL_SHA}

          ⚠️ **Disclaimer**: This is a __pre-release__ build. Expect bugs and instability.

          ### Downloads
          | Platform | Architecture | File |
          |----------|-------------|------|
          | Linux | x86_64 | \`3SX-${SHORT_SHA}-linux-x86_64.tar.gz\` |
          | Linux | ARM64 | \`3SX-${SHORT_SHA}-linux-arm64.tar.gz\` |
          | Windows | x86_64 | \`3SX-${SHORT_SHA}-windows.zip\` |
          | macOS | arm64 | \`3SX-${SHORT_SHA}-macos.dmg\` |
          | Linux (Flatpak) | x86_64 | \`3sx.flatpak\` |
          EOF

          if gh release view "${TAG_NAME}" >/dev/null 2>&1; then
            gh release edit "${TAG_NAME}" \
              --title "${SHORT_SHA}" \
              --prerelease \
              --notes-file notes.md

            for asset in $(gh release view "${TAG_NAME}" --json assets --jq '.assets[].name'); do
              gh release delete-asset "${TAG_NAME}" "${asset}" --yes
            done

            gh release upload "${TAG_NAME}" release-assets/* --clobber
          else
            gh release create "${TAG_NAME}" release-assets/* \
              --title "${SHORT_SHA}" \
              --prerelease \
              --notes-file notes.md
          fi
