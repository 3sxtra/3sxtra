name: Create Release

on:
  push:
    branches:
      - "main"

permissions:
  contents: write

jobs:
  build-linux:
    name: Build (Linux x86_64)
    uses: ./.github/workflows/build_linux.yml
    with:
      release: true

  build-linux-arm64:
    name: Build (Linux ARM64)
    uses: ./.github/workflows/build_linux_arm64.yml
    with:
      release: true

  build-windows:
    name: Build (Windows x86_64)
    uses: ./.github/workflows/build_windows.yml
    with:
      release: true

  build-macos:
    name: Build (macOS arm64)
    uses: ./.github/workflows/build_macos.yml
    with:
      release: true

  build-flatpak:
    name: Build (Flatpak)
    uses: ./.github/workflows/build_flatpak.yml
    with:
      release: true

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-linux-arm64, build-windows, build-macos, build-flatpak]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all release assets
        uses: actions/download-artifact@v4
        with:
          pattern: release-assets-*
          merge-multiple: true
          path: release-assets

      - name: Move rolling release tag
        env:
          TAG_NAME: rolling-pre-release
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -f "${TAG_NAME}" "${GITHUB_SHA}"
          git push origin "refs/tags/${TAG_NAME}" --force

      - name: Create or update GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG_NAME: rolling-pre-release
          FULL_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          SHORT_SHA="${FULL_SHA:0:7}"

          cat > notes.md <<EOF
          Automatic release for commit ${FULL_SHA}

          ⚠️ **Disclaimer**: This is a __pre-release__ build. Expect bugs and instability.

          ### Downloads
          | Platform | Architecture | File |
          |----------|-------------|------|
          | Linux | x86_64 | \`3SX-${SHORT_SHA}-linux-x86_64.tar.gz\` |
          | Linux | ARM64 | \`3SX-${SHORT_SHA}-linux-arm64.tar.gz\` |
          | Windows | x86_64 | \`3SX-${SHORT_SHA}-windows.zip\` |
          | macOS | arm64 | \`3SX-${SHORT_SHA}-macos.dmg\` |
          | Linux (Flatpak) | x86_64 | \`3sx.flatpak\` |
          EOF

          if gh release view "${TAG_NAME}" >/dev/null 2>&1; then
            gh release edit "${TAG_NAME}" \
              --title "${SHORT_SHA}" \
              --prerelease \
              --notes-file notes.md

            for asset in $(gh release view "${TAG_NAME}" --json assets --jq '.assets[].name'); do
              gh release delete-asset "${TAG_NAME}" "${asset}" --yes
            done

            gh release upload "${TAG_NAME}" release-assets/* --clobber
          else
            gh release create "${TAG_NAME}" release-assets/* \
              --title "${SHORT_SHA}" \
              --prerelease \
              --notes-file notes.md
          fi
