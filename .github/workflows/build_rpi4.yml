name: Build (Raspberry Pi 4 / Batocera)

on:
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "main" ]

jobs:
    build:
        name: Build (RPi4 Cross-Compile)
        runs-on: ubuntu-latest
        container:
            image: ubuntu:25.04

        steps:
          - name: Install Git and cross-compile toolchain
            env:
                DEBIAN_FRONTEND: noninteractive
                TZ: UTC
            run: |
                apt-get update
                apt-get install -y git curl xz-utils nodejs

                # ARM64 packages live on ports.ubuntu.com
                dpkg --add-architecture arm64

                # Pin existing DEB822 sources to amd64-only
                for f in /etc/apt/sources.list.d/*.sources; do
                    if [ -f "$f" ] && ! grep -q 'Architectures:' "$f"; then
                        sed -i '/^Types:/a Architectures: amd64' "$f"
                    fi
                done

                # Add arm64 sources
                printf '%s\n' \
                    'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports plucky main restricted universe multiverse' \
                    'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports plucky-updates main restricted universe multiverse' \
                    'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports plucky-security main restricted universe multiverse' \
                    > /etc/apt/sources.list.d/arm64-ports.list

                apt-get update
                apt-get install -y crossbuild-essential-arm64 cmake ninja-build make pkg-config clang zip file qemu-user-static python3-jinja2

          - name: Install Rust toolchain (cross-compile)
            run: |
                export RUSTUP_HOME=/opt/rustup
                export CARGO_HOME=/opt/cargo
                curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
                echo "RUSTUP_HOME=/opt/rustup" >> $GITHUB_ENV
                echo "CARGO_HOME=/opt/cargo" >> $GITHUB_ENV
                echo "/opt/cargo/bin" >> $GITHUB_PATH
                . /opt/cargo/env
                rustup target add aarch64-unknown-linux-gnu

          - name: Checkout repository
            uses: actions/checkout@v4
            with:
                submodules: recursive

          - name: Cache dependencies
            uses: actions/cache@v4
            with:
                path: third_party_rpi4
                key: linux-rpi4-deps-${{ hashFiles('build-deps.sh') }}
                restore-keys: linux-rpi4-deps-

          - name: Cache Rust/Cargo
            uses: actions/cache@v4
            with:
                path: |
                    /opt/cargo/registry
                    /opt/cargo/git
                key: linux-rpi4-cargo-${{ hashFiles('build-deps.sh') }}
                restore-keys: linux-rpi4-cargo-

          - name: Install ARM64 build dependencies
            env:
                DEBIAN_FRONTEND: noninteractive
            run: |
                apt-get install -y \
                  libasound2-dev:arm64 libpulse-dev:arm64 \
                  libx11-dev:arm64 libxext-dev:arm64 libxrandr-dev:arm64 \
                  libxcursor-dev:arm64 libxfixes-dev:arm64 libxi-dev:arm64 \
                  libxrender-dev:arm64 libxinerama-dev:arm64 libxtst-dev:arm64 \
                  libxss-dev:arm64 libxkbcommon-dev:arm64 libxkbcommon-x11-dev:arm64 \
                  libdrm-dev:arm64 libgbm-dev:arm64 \
                  libgl1-mesa-dev:arm64 libgles2-mesa-dev:arm64 \
                  libegl1-mesa-dev:arm64 libdbus-1-dev:arm64 libudev-dev:arm64 \
                  libpipewire-0.3-dev:arm64 \
                  libwayland-dev:arm64 libwayland-egl1:arm64 libdecor-0-dev:arm64 \
                  libminiupnpc-dev:arm64 \
                  wayland-protocols

          - name: Pre-build dependencies
            env:
                CARGO_BUILD_TARGET: aarch64-unknown-linux-gnu
                CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
                CC: aarch64-linux-gnu-gcc
                CXX: aarch64-linux-gnu-g++
                PKG_CONFIG_PATH: /usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
                PKG_CONFIG_LIBDIR: /usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
            run: |
                cd $GITHUB_WORKSPACE
                export THIRD_PARTY=$GITHUB_WORKSPACE/third_party_rpi4
                export THIRD_PARTY_DIR=$THIRD_PARTY
                chmod +x ./build-deps.sh
                ./build-deps.sh

                mkdir -p $THIRD_PARTY/librashader/target/release
                cp $THIRD_PARTY/librashader/target/aarch64-unknown-linux-gnu/release/liblibrashader_capi.a $THIRD_PARTY/librashader/target/release/
            shell: bash

          - name: Build 3SX for RPi4
            env:
                PKG_CONFIG_PATH: /usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
                PKG_CONFIG_LIBDIR: /usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
            run: |
                set -o pipefail
                cmake -B build_rpi4 \
                    -DCMAKE_BUILD_TYPE=Release \
                    -DCMAKE_TOOLCHAIN_FILE=cmake/aarch64-linux-gnu.cmake \
                    -DPLATFORM_RPI4=ON \
                    -DENABLE_TESTS=OFF \
                    -DTHIRD_PARTY_DIR=$GITHUB_WORKSPACE/third_party_rpi4 \
                    -G Ninja
                cmake --build build_rpi4 --parallel
            shell: bash

          - name: Package artifact
            run: |
                bash tools/batocera/rpi4/deploy.sh
                mv game_deployment.tar.gz 3sx-rpi4-batocera.tar.gz

          - name: Save artifact (local act)
            if: ${{ env.ACT }}
            run: |
                mkdir -p $GITHUB_WORKSPACE/build_output
                cp 3sx-rpi4-batocera.tar.gz $GITHUB_WORKSPACE/build_output/
                echo "âœ… Artifact saved to build_output/3sx-rpi4-batocera.tar.gz"

          - name: Upload artifact (GitHub)
            if: ${{ !env.ACT }}
            uses: actions/upload-artifact@v4
            with:
                name: 3sx-batocera-rpi4
                path: 3sx-rpi4-batocera.tar.gz
